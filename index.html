<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Change Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; display: flex; background: #0a1d3b; color: #333; margin: 0; min-height: 100vh; }
    .left { flex: 1; background: #0a1d3b; color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 24px; }
    .left h2 { margin-top: 16px; text-align: center; }
    .right { flex: 1; background: #fff; padding: 40px; display: flex; flex-direction: column; justify-content: center; }
    h1 { margin-bottom: 10px; }
    .rules { font-size: 14px; margin-bottom: 20px; color: #444; }
    label { font-weight: bold; margin-top: 10px; display:block; }
    input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    .buttons { margin-top: 20px; display: flex; gap: 10px; }
    button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    .back { background: #004aad; color: #fff; }
    .submit { background: #008cff; color: #fff; }
    .notice { background:#f6f7fb; border:1px solid #e5e7f2; padding:10px 12px; border-radius:8px; margin-bottom:16px; color:#333; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="left">
    <img src="https://via.placeholder.com/150" alt="Identity Shoppe Logo" />
    <h2>Intelligent Identity.<br>Smarter Security.</h2>
    <p>Cloud Security &amp; Identity Governance</p>
  </div>

  <div class="right">
    <h1>Change Password</h1>

    <div id="preAuth" class="notice hidden">
      Redirecting you to sign in securely…
    </div>

    <div class="rules">
      <p>Must be at least <i>twelve characters</i> long</p>
      <p>Must contain at least one upper and lower case characters</p>
      <p>Must contain at least one alphanumeric character</p>
      <p>Must contain at least one special character</p>
      <p>Must not match your EID or any portion of your EID</p>
      <p>Must not contain three repeating characters (example: xxxx5)</p>
      <p>Must not contain spaces</p>
      <p>Cannot be the same as the last four passwords used</p>
      <p><b>Please wait at least 1 minute before attempting to log back in after changing your password</b></p>
    </div>

    <!-- Removed action="/password-reset" (static sites can’t accept POST).
         If you DO have a backend, set PASSWORD_RESET_API below and we will fetch() it. -->
    <form id="resetForm">
      <label>Username *</label>
      <input id="username" type="text" name="username" value="" readonly>

      <label>New Password *</label>
      <input id="newPassword" type="password" name="newPassword" required>

      <label>Confirm Password *</label>
      <input id="confirmPassword" type="password" name="confirmPassword" required>

      <div class="buttons">
        <button type="button" class="back" id="backBtn">Back</button>
        <button type="submit" class="submit">Submit</button>
      </div>
    </form>

    <div id="msg" class="notice hidden"></div>
  </div>

  <script>
    // ===== CONFIG: EDIT THESE =====
    // IdP-initiated SSO start URL (PingFederate). Example:
    // https://pf.example.com/idp/startSSO.ping?PartnerSpId=YourSP&TargetResource=<this-page-url-encoded>
    const PF_SSO_START = 'https://<pf-host>/idp/startSSO.ping?PartnerSpId=<YourSPConnectionId>&TargetResource='
                       + encodeURIComponent(window.location.origin + window.location.pathname + '?sso=1');

    // If you have an API that actually performs password reset, put it here (HTTPS, CORS-enabled).
    const PASSWORD_RESET_API = ''; // e.g., 'https://api.example.com/password-reset'

    // ===== HELPERS =====
    const $ = (id) => document.getElementById(id);
    function qs(name) { return new URLSearchParams(window.location.search).get(name); }

    function ensureAuthenticatedOrKickoff() {
      const isAfterSso = qs('sso') === '1';
      // If your ACS redirects back including a uid/username, we’ll use it.
      const uid = qs('uid') || qs('username') || '';
      if (!isAfterSso && !uid) {
        // Not authenticated → kick off IdP-initiated SSO (GET).
        $('preAuth').classList.remove('hidden');
        window.location.replace(PF_SSO_START);
        return false;
      }
      // Pre-fill username if provided by your ACS redirect
      if (uid) $('username').value = uid;
      return true;
    }

    function validatePasswords(pw1, pw2) {
      if (pw1 !== pw2) return 'Passwords do not match.';
      if (pw1.length < 12) return 'Password must be at least 12 characters.';
      if (!/[A-Z]/.test(pw1) || !/[a-z]/.test(pw1)) return 'Include upper and lower case letters.';
      if (!/[0-9]/.test(pw1)) return 'Include at least one digit.';
      if (!/[^\w\s]/.test(pw1)) return 'Include at least one special character.';
      if (/\s/.test(pw1)) return 'Password cannot contain spaces.';
      if (/(.)\1\1/.test(pw1)) return 'Avoid three repeating characters.';
      return '';
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      ensureAuthenticatedOrKickoff();

      $('backBtn').addEventListener('click', () => {
        // Go back to wherever you want (home, login, etc.)
        history.length > 1 ? history.back() : window.location.href = '/';
      });

      $('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = $('username').value.trim();
        const pw1 = $('newPassword').value;
        const pw2 = $('confirmPassword').value;

        const err = validatePasswords(pw1, pw2);
        if (err) { showMsg(err); return; }

        if (!PASSWORD_RESET_API) {
          showMsg('Demo mode: no API configured. Replace PASSWORD_RESET_API with your backend endpoint.', true);
          return;
        }

        // Example POST to your backend (NOT GitHub Pages)
        try {
          const res = await fetch(PASSWORD_RESET_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, newPassword: pw1 })
          });
          if (!res.ok) throw new Error(await res.text());
          showMsg('Password changed successfully. Please wait at least 1 minute before logging back in.', true);
          $('resetForm').reset();
        } catch (e2) {
          showMsg('Password change failed: ' + (e2.message || e2), false);
        }
      });
    });

    function showMsg(text, success = false) {
      const el = $('msg');
      el.textContent = text;
      el.style.borderColor = success ? '#30b066' : '#e0b4b4';
      el.style.background  = success ? '#eefaf3' : '#fbeeee';
      el.classList.remove('hidden');
    }
  </script>
</body>
</html>
